<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSI Readings — Interactive</title>
  <style>
    :root{
      --bg:#e8f1f2; --ink:#0b1320;
      --card:#0e1117; --line:#222733;
      --thead:#111827; --thead-ink:#e5e7eb;
      --cell:#0f172a; --cell-alt:#111827;
      --focus:#22d3ee;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{padding:1.5rem 1rem}
    .wrap{max-width:1200px;margin:0 auto;padding:0 1rem}
    .controls{display:flex;flex-wrap:wrap;gap:.75rem 1rem;align-items:center;margin:.5rem 0 1rem}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:0 4px 16px rgba(2,6,23,.25);margin:1rem 0}
    .bar{background:var(--thead);color:var(--thead-ink);padding:.7rem 1rem;display:flex;align-items:center;justify-content:space-between;font-weight:700}
    .stamp{font-weight:600}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:.45rem .75rem;cursor:pointer}
    .btn:focus{outline:2px solid var(--focus);outline-offset:1px}
    .input{border:1px solid var(--line);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:.45rem .6rem}
    .toggles{display:flex;flex-wrap:wrap;gap:.35rem .75rem}
    .pill{display:inline-flex;gap:.4rem;align-items:center;background:#0b1220;border:1px solid var(--line);color:#e5e7eb;padding:.25rem .5rem;border-radius:999px}
    .pill input{accent-color:#22d3ee}
    #error{color:#f87171;font-weight:700;padding:1rem}
    table{width:100%;border-collapse:separate;border-spacing:0}
    caption{caption-side:top;background:var(--thead);color:var(--thead-ink);font-weight:700;padding:.6rem 1rem;text-align:center}
    thead th{position:sticky;top:0;background:var(--thead);color:var(--thead-ink);border-bottom:1px solid var(--line);user-select:none;cursor:pointer}
    th,td{padding:.72rem .75rem;border-bottom:1px solid var(--line);text-align:center;font-variant-numeric:tabular-nums;color:#d1d5db}
    th:first-child,td:first-child{text-align:left}
    th:first-child{width:24%; cursor:default}
    tbody tr:nth-child(odd) td{background:var(--cell)}
    tbody tr:nth-child(even) td{background:var(--cell-alt)}
    tbody tr:hover td{filter:brightness(1.12)}
    .reading{font-weight:600;color:#e2e8f0}
    .sorted-asc::after{content:" ▲";font-size:.8em;color:#93c5fd}
    .sorted-desc::after{content:" ▼";font-size:.8em;color:#93c5fd}
    .col-highlight{box-shadow: inset 0 0 0 9999px rgba(255,255,255,.04)}
    @media (max-width:720px){ th:first-child{width:38%} }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>PSI Readings — Interactive Table</h1>
    <p>Sort by any column, search metrics, toggle region visibility, and download the table as CSV.</p>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="bar">
        <span>Singapore PSI Realtime Readings</span>
        <span id="stamp" class="stamp">Loading…</span>
      </div>

      <!-- interactive controls -->
      <div class="controls" id="controls">
        <input id="search" class="input" type="search" placeholder="Search metric… (e.g., pm25)" aria-label="Search metric" />
        <button id="csvBtn" class="btn" type="button">Download CSV</button>
        <div id="toggles" class="toggles" aria-label="Toggle regions"></div>
      </div>

      <div id="table"></div>
      <div id="error" role="alert" aria-live="assertive"></div>
    </section>
  </main>

  <!-- D3.js v7 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    const API = "https://api.data.gov.sg/v1/environment/psi";
    const ORDER = [
      "o3_sub_index",
      "pm10_twenty_four_hourly",
      "pm10_sub_index",
      "co_sub_index",
      "pm25_twenty_four_hourly",
      "so2_sub_index",
      "co_eight_hour_max",
      "no2_one_hour_max",
      "so2_twenty_four_hourly",
      "pm25_sub_index",
      "psi_twenty_four_hourly",
      "o3_eight_hour_max"
    ];
    const LABELS = Object.fromEntries(ORDER.map(k => [k, k]));

    const stampSel = d3.select("#stamp");
    const errorSel = d3.select("#error");
    const tableRoot = d3.select("#table");
    const togglesRoot = d3.select("#toggles");
    const searchInput = d3.select("#search");
    const csvBtn = d3.select("#csvBtn");

    let regions = [];
    let readings = {};
    let visibleRegions = new Set(); // which region columns are shown
    let sortState = { key: null, direction: null }; // {key: 'west', 'Metric', direction: 'asc'|'desc'}

    // Helpers
    const formatStamp = (iso) => {
      const dt = new Date(iso);
      const fmt = { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' };
      return dt.toLocaleString(undefined, fmt);
    };

    function buildToggles() {
      togglesRoot.selectAll("*").remove();
      const items = togglesRoot
        .selectAll("label.pill")
        .data(regions, d => d)
        .enter()
        .append("label")
        .attr("class", "pill");

      items.append("input")
        .attr("type", "checkbox")
        .attr("checked", d => visibleRegions.has(d) ? true : null)
        .attr("aria-label", d => "toggle " + d + " region")
        .on("change", function(e, d){
          if (this.checked) visibleRegions.add(d); else visibleRegions.delete(d);
          renderTable(); // re-render with visibility
        });

      items.append("span")
        .text(d => d.charAt(0).toUpperCase()+d.slice(1));
    }

    function getFilteredMetrics() {
      const q = (searchInput.node().value || "").trim().toLowerCase();
      if (!q) return ORDER.slice();
      return ORDER.filter(k => (LABELS[k]||k).toLowerCase().includes(q));
    }

    function valueOf(cell){
      // parse numeric if possible
      const v = (cell === null || cell === undefined) ? null : +cell;
      return Number.isNaN(v) ? cell : v;
    }

    function applySort(rowsData) {
      const { key, direction } = sortState;
      if (!key || !direction) return rowsData;
      const sorted = rowsData.slice();
      if (key === "Metric") {
        sorted.sort((a,b) => (LABELS[a]||a).localeCompare(LABELS[b]||b));
      } else {
        // sort by selected region column
        sorted.sort((a,b) => {
          const va = valueOf((readings[a]||{})[key]);
          const vb = valueOf((readings[b]||{})[key]);
          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;
          if (typeof va === "number" && typeof vb === "number") return va - vb;
          return String(va).localeCompare(String(vb));
        });
      }
      if (direction === "desc") sorted.reverse();
      return sorted;
    }

    function renderTable() {
      tableRoot.selectAll("*").remove();

      const metrics = applySort(getFilteredMetrics());
      const activeRegions = regions.filter(r => visibleRegions.has(r));

      const table = tableRoot.append("table");
      const caption = table.append("caption").text("Last updated " + stampSel.text().replace("Updated: ",""));
      const thead = table.append("thead");
      const tbody = table.append("tbody");

      // Header
      const headerRow = thead.append("tr");
      headerRow.append("th")
        .text("Metric")
        .attr("data-col","Metric")
        .classed("sorted-asc", sortState.key==="Metric" && sortState.direction==="asc")
        .classed("sorted-desc", sortState.key==="Metric" && sortState.direction==="desc")
        .on("click", () => toggleSort("Metric"));

      const th = headerRow.selectAll("th.region")
        .data(activeRegions, d => d)
        .enter()
        .append("th")
        .attr("class","region")
        .attr("data-col", d => d)
        .text(d => d.charAt(0).toUpperCase() + d.slice(1))
        .classed("sorted-asc", d => sortState.key===d && sortState.direction==="asc")
        .classed("sorted-desc", d => sortState.key===d && sortState.direction==="desc")
        .on("click", (e,d) => toggleSort(d))
        .on("mouseover", function(){ // highlight column on hover
          const col = d3.select(this).attr("data-col");
          table.selectAll(`[data-col="${col}"]`).classed("col-highlight", true);
        })
        .on("mouseout", function(){
          table.selectAll(".col-highlight").classed("col-highlight", false);
        });

      // Rows
      const rows = tbody.selectAll("tr")
        .data(metrics, d => d)
        .enter()
        .append("tr");

      rows.append("td")
        .attr("class","reading")
        .attr("data-col","Metric")
        .text(k => LABELS[k] || k);

      rows.selectAll("td.val")
        .data(k => activeRegions.map(r => ({ col:r, value:(readings[k]||{})[r] })))
        .enter()
        .append("td")
        .attr("class","val")
        .attr("data-col", d => d.col)
        .text(d => (d.value === null || d.value === undefined) ? "—" : d.value);
    }

    function toggleSort(col){
      if (sortState.key !== col){
        sortState = { key: col, direction: "asc" };
      } else {
        sortState.direction = (sortState.direction === "asc") ? "desc" : "asc";
      }
      renderTable();
    }

    function exportCSV(){
      const metrics = applySort(getFilteredMetrics());
      const activeRegions = regions.filter(r => visibleRegions.has(r));
      const header = ["Metric", ...activeRegions];
      const rows = metrics.map(m => [
        LABELS[m] || m,
        ...activeRegions.map(r => (readings[m]||{})[r] ?? "")
      ]);
      const csv = [header, ...rows].map(r => r.map(v => {
        const s = String(v);
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "psi_readings.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Init
    (async function(){
      try{
        const data = await d3.json(API, { cache: "no-store" });
        const item = (data && data.items && data.items[0]) || null;
        if (!item) throw new Error("No items in API response.");

        // Timestamp
        const updatedISO = item.update_timestamp || item.timestamp || null;
        stampSel.text(updatedISO ? ("Updated: " + formatStamp(updatedISO)) : "Updated: —");

        // Readings + regions
        readings = item.readings;
        const firstKey = ORDER.find(k => readings[k]);
        regions = Object.keys(readings[firstKey]);   // national, central, west, east, north, south
        visibleRegions = new Set(regions);           // all visible by default

        buildToggles();
        renderTable();

        // Wire controls
        searchInput.on("input", () => renderTable());
        csvBtn.on("click", exportCSV);
      }catch(e){
        errorSel.text(e.message || String(e));
        console.error(e);
      }
    })();
  </script>
</body>
</html>
